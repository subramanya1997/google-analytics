# GitHub Actions workflow to deploy Data Service to Azure Functions
#
# Prerequisites:
# 1. Create a Function App in Azure Portal
# 2. Download the Publish Profile from Function App → "Get publish profile"
# 3. Add it as a GitHub secret named AZURE_FUNCTIONAPP_PUBLISH_PROFILE
#
# Triggers:
# - Push to feat/azure_functions or main branch (only when function code changes)
# - Manual trigger via workflow_dispatch

name: Deploy Data Service to Azure Functions

on:
  push:
    branches:
      - feat/azure_functions
      - main
      - master
    paths:
      - 'backend/services/data_service_functions/**'
      - '.github/workflows/master_gadataingestion.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_FUNCTIONAPP_NAME: 'gadataingestion'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'backend/services/data_service_functions'
  PYTHON_VERSION: '3.10'

jobs:
  # Job 1: Build and Package with Dependencies
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Validate requirements.txt exists
      run: |
        cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        if [ ! -f requirements.txt ]; then
          echo "Error: requirements.txt not found"
          exit 1
        fi
        echo "✓ requirements.txt found"
        echo "Contents:"
        cat requirements.txt

    - name: Build dependencies in Azure Functions Docker environment
      run: |
        cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        # Use Azure Functions Python 3.10 Docker image to build dependencies
        docker run --rm \
          -v $(pwd):/home/site/wwwroot \
          -w /home/site/wwwroot \
          mcr.microsoft.com/azure-functions/python:4-python3.10 \
          bash -c "pip install --target=./.python_packages/lib/site-packages -r requirements.txt && ls -la .python_packages/lib/site-packages/ | head -20"
        
        echo "✓ Dependencies installed in Azure-compatible environment"
        ls -la .python_packages/lib/site-packages/ | grep -i sqlalchemy

    - name: Upload artifact for deployment
      uses: actions/upload-artifact@v4
      with:
        name: function-app-package
        path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        retention-days: 1
        include-hidden-files: true

  # Job 2: Deploy to Azure
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app-package
        path: ./function-app

    - name: Login to Azure
      uses: Azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Verify package contents before deployment
      run: |
        echo "Package contents:"
        ls -la ./function-app/
        echo ""
        echo "Checking for .python_packages:"
        if [ -d "./function-app/.python_packages" ]; then
          echo "✓ .python_packages found"
          ls ./function-app/.python_packages/lib/site-packages/ | grep -i sqlalchemy
        else
          echo "ERROR: .python_packages missing!"
          exit 1
        fi

    - name: Deploy to Azure Functions
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ./function-app
        scm-do-build-during-deployment: false
        enable-oryx-build: false
    
    - name: Wait for deployment to complete
      run: |
        echo "Waiting 30 seconds for deployment to stabilize..."
        sleep 30
    
    - name: Verify deployment health
      run: |
        echo "Testing health endpoint..."
        curl -f https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/v1/health || echo "Health check failed - app may still be starting"

    - name: Deployment summary
      run: |
        echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Function App:** ${{ env.AZURE_FUNCTIONAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Data Ingestion Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/health\` - Health check" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/ingest\` - Start ingestion job (processes automatically)" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/jobs\` - List ingestion jobs" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/jobs/{job_id}\` - Get job status" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/data-availability\` - Data availability" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/data/schedule\` - Get schedule" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/data/schedule\` - Update schedule" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Email Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/email/send-reports\` - Send branch reports" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/email/jobs/{job_id}\` - Get email job status" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/email/mappings\` - List email mappings" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/email/mappings\` - Create email mapping" >> $GITHUB_STEP_SUMMARY

