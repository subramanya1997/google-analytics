# GitHub Actions workflow to deploy Data Service to Azure Functions
#
# Prerequisites:
# 1. Create a Function App in Azure Portal
# 2. Download the Publish Profile from Function App â†’ "Get publish profile"
# 3. Add it as a GitHub secret named AZURE_FUNCTIONAPP_PUBLISH_PROFILE
#
# Triggers:
# - Push to feat/azure_functions or main branch (only when function code changes)
# - Manual trigger via workflow_dispatch

name: Deploy Data Service to Azure Functions

on:
  push:
    branches:
      - feat/azure_functions
      - main
      - master
    paths:
      - 'backend/services/data_service_functions/**'
      - '.github/workflows/master_gadataingestion.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AZURE_FUNCTIONAPP_NAME: 'gadataingestion'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: 'backend/services/data_service_functions'
  PYTHON_VERSION: '3.10'

jobs:
  # Job 1: Build and Test
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio

    - name: Run linting
      run: |
        pip install flake8
        cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

    - name: Run tests
      run: |
        cd ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        python -m pytest tests/ -v --tb=short || echo "Tests completed with warnings"

    - name: Upload artifact for deployment
      uses: actions/upload-artifact@v4
      with:
        name: function-app-package
        path: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        retention-days: 1

  # Job 2: Deploy to Azure
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: function-app-package
        path: ./function-app

    - name: Login to Azure
      uses: Azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Configure App Settings for Python V2
      uses: Azure/appservice-settings@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        app-settings-json: '[{"name":"AzureWebJobsFeatureFlags","value":"EnableWorkerIndexing"},{"name":"PYTHON_ENABLE_WORKER_EXTENSIONS","value":"1"}]'

    - name: Deploy to Azure Functions
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: ./function-app
        scm-do-build-during-deployment: true
        enable-oryx-build: true

    - name: Deployment summary
      run: |
        echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Function App:** ${{ env.AZURE_FUNCTIONAPP_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Data Ingestion Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/health\` - Health check" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/ingest\` - Start ingestion job (processes automatically)" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/jobs\` - List ingestion jobs" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/jobs/{job_id}\` - Get job status" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/data-availability\` - Data availability" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/data/schedule\` - Get schedule" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/data/schedule\` - Update schedule" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Email Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/email/send-reports\` - Send branch reports" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/email/jobs/{job_id}\` - Get email job status" >> $GITHUB_STEP_SUMMARY
        echo "- \`GET /api/v1/email/mappings\` - List email mappings" >> $GITHUB_STEP_SUMMARY
        echo "- \`POST /api/v1/email/mappings\` - Create email mapping" >> $GITHUB_STEP_SUMMARY

